> LVS是Linux Virtual Server的简写，Linux虚拟服务器，又称负载均衡器，用来实现负载均衡集群的。支持千万级以上PV规模场景。

> Kaeepalived可以基于OSI网络模型中的3、4、7层工作，即网络层、传输层、应用层，主要工作可以实现健康检测、负载均衡等。

LVS负载均衡是基于转发方式和算法来实现的，转发方式分别为**NAT、DR、TUN**模式，算法包括：RR、LC、WRR、WLC模式等多种算法（RR为轮询模式，LC为最少连接模式）。

LVS NAT原理：用户请求LVS VIP到达DR(负载均衡服务器)，DR**将请求的报文的目标IP地址改为后端真实服务器IP地址**，同时**将报文的目标端口改为后端服务器指定端口**，最后将报文转发给真实服务器，真实服务器将数据返回给DR，DR再把数据发送给用户。（请求和响应两次行为都经过DR，所以如果访问量过大，DR会成为瓶颈，后端服务器要将路由指向DR） 扩展full-nat，如下图：
![lvs_net.png][1]
LVS DR原理：用户请求LVS VIP到达DR，DR**将请求的报文的目标MAC地址改为后端真实服务器MAC地址**，目标IP为VIP（不变），源IP改为用户IP地址，DR将报文发送到真实服务器，真实服务器检测目标VIP为自己本地VIP，则响应请求，如果在同一个网段，则直接返回请求给用户，如果用户和真实服务器不在同一网段，则通过网关返回给用户。（效率最高，修改后端内核参数）如下图：
![lvs_dr.png][2]
LVS TUN原理：用户请求LVS到达DR，DR**通过IP-TUN隧道加密技术将请求的报文的目标MAC地址改为到达后端真实服务器的网关MAC地址**，目标IP为VIP，源IP为用户IP，DR将报文发送到后端真实服务器，真实服务器基于隧道技术解密，检测目标IP为本地VIP，如果用户和真实服务器在用一网段则直接响应请求给用户，如果不在同一网段则通过网关返回给用户。（支持跨网段，修改后端内核参数）如下图：
![lvs_tun.png][3]

三种模式的部署方法基本一致，在指定模式的时候可用ipvsadm 的-m（NAT） -i（TUM） -g（DR）参数指定转发模式。

LVS软件名为ipvsadm，ipvsadm是IP_VS模块的管理工具，可以用**yum install ipvsadm* -y**直接安装，也可以在官网下载源码进行编译安装。

LVS的核心模块是IP_VS模块，IP_VS模块默认已经集成在linux内核当中，可以使用**lsmod | greo -i ip_vs**查看模块，如果没有该模块可用**modprobe ip_vs**命令来加载ip_vs模块，如果没有该模块也可手动编译内核添加模块。

LVS只能实现后端服务器的负载均衡，但是不能实现服务器的故障切换，所以LVS+keepalived组合即可实现负载均衡，又通过keepalived的健康检测功能来实现服务器的故障自动切换。

LVS+keepalived组合无需手工添加ipvsadm虚拟IP、LVS网卡绑定虚拟IP等操作，通过keepalived.conf配置文件均可配置，



[1]: ../images/762254881.png
[2]: ../images/1036492470.png
[3]: ../images/1150989623.png