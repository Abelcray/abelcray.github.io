# Linux服务篇（MYSQL主从复制）

<!--markdown-->> MYSQL主从同步是为了保证WEB网站高可用，防止MYSQL数据库单点问题，从而引入备份服务器。备份MYSQL数据库；MYSQL主从同步也成为MYSQL主从同步，通过从库定时从主库同步SQL数据来实现复制。

主从复制原理

1. MYSQL主从保证，主库和从库数据要保持一致，才能起到对主库的备份。
2. MYSQL主从同步是一个异步复制的过程，中间有延迟（毫秒或秒级，非常小），如果数据量非常大，同步延迟可能会大一些；  
3. MYSQL主从同步需要开启三个线程，Master库开启I/O线程，Slave库开启I/O线程和SQL线程。 
4. Slave端启动I/O线程，并通过I/O线程向Master库发起请求（主要请求Master端bin-log文件中的内容，某个PISITION位置点起始）。
5. Bin-log是二进制日志文件，用于记录在MYSQL数据库中各种执行的SQL语句（增、删、改、插入），Bin-log开启之后，会实时记录数据库中执行修改的SQL语句。
6. Bin-log文件记录SQL语句一般是按照position位置点，默认起始有一个位置点。假设position点为106，当执行SQL更新语句后，position点会变成266，简单来说，Bin-log文件会记录任何写入或者更改数据库的语句。
7. Master端接收Slave的I/O线程发送过来的请求后，Master端以I/O线程处理请求，通过命令行中show processlist看dump thread线程，Bin-log内容发送给Slave端。
8. Slave端收到Bin-log文件中的内容，将内容追加到本地中继日志relay-log文件中，写入master.info（记录此次同步的masterIP、用户名、密码、position点，方便下次同步）。
9. Slave端的SQL线程，实时监听relay-log日志是否有更新，如果有更新，SQL会去解析文件中的代码，解析出SQL语句，并且在本地数据库中执行，执行完的效果和Master库中的数据保持一致，从而实现主从复制同步；

------

MYSQL主从复制配置（2台安装有MYSQL的服务器）,MasterIP:172.16.1.128;SlaveIP:172.16.1.129

安装MYSQL

```
yum install mariadb mariadb-devel mariadb-server -y
```

Master主库：
在/etc/my.cnf文件中[mysqld]栏中添加以下内容

```
server-id=1
log-bin=mysql-bin
```

修改配置文件后重启服务

```
systemctl restart mariadb
```

进入数据库创建同步用户和密码并设置权限，查看bin-log文件和position点；

```
grant replication slave on *.* to 'backup'@'172.16.1.129' identified by '123456';
show master status;
```

![mstatus.png][1]

记录下File名和Position点的值

Slave从库：
在/etc/my.cnf文件中[mysqld]栏中添加以下内容

```
server-id=2
```

登陆数据库指定master用户名密码、bin-log和position；并查看从库状态。

```
change master to master_host='172.16.1.128',master_user='backup',master_password='123456',master_log_file='mysql-bin.000001',master_log_pos=400;
start slave;
show slave status`\`G;
```

![status.png][2]

[1]: ../images/4276440759.png
[2]: ../images/538106750.png

如果两个线程的状态为YES则主从复制部署成功。



# （MYSQL-Proxy）读写分离

<!--markdown-->> MYSQL读写分离实际上就是让Master数据库处理事务性增、删、改、更新操作，让Slave数据库处理查询操作，MYSQL读写分离的前提是基于MYSQL主从复制，这样可以保证在Master上修改数据，Slave同步之后WEB应用可以读取到Slave端的数据。

实现MYSQL读写分离一般基于第三方插件来实现，因为通过开发修改代码的实施难度较大；具体实现读写分离的常见方式有MYSQL-Proxy读写分离、Amoeba读写分离、Mycat读写分离等。

下面以MYSQL-Proxy为中间件来实现MYSQL读写分离，MYSQL-Proxy是MYSQL官方提供的MYSQL中间件服务，支持无数客户端连接，同时后端可连接若干台MYSQL服务器，MYSQL-Proxy自身基于MYSQL协议，连接MYSQL-Proxy的客户端无需修改任何设置，跟正常连接MYSQL服务没有任何区别，无需修改任何程序代码。

首先准备四台服务器，一台LAPWEB应用服务器(Discuz论坛实例)，两台MYSQL服务器配置为主从复制，1台MYSQL-Proxy服务器（也可在WEB应用服务器上配置MYSQL-Proxy）。

```
LAPIP：172.16.1.130
MYSQL-MasterIP:172.16.1.128
MYSQL-SlaveIP:172.16.1.129
MYSQL-ProxyIP:172.16.1.131
```

LAPWEB应用安装(注：YUM安装apache和php自动整合，源码编译需手动整合)

```
yum install httpd httpd-devel php-devel php php-mysql  php-fpm -y
```

准备好Discuz论坛源码包

```
unzip Discuz_X3.4_SC_UTF8.zip 
mv upload/* /var/www/html/
systemctl restart httpd php-fpm 
```

安装MYSQL-Proxy（此包为免编译软件包）

```
wget http://ftp.ntu.edu.tw/pub/MySQL/Downloads/MySQL-Proxy/mysql-proxy-0.8.5-linux-glibc2.3-x86-64bit.tar.gz
tar zxvf mysql-proxy-0.8.5-linux-glibc2.3-x86-64bit.tar.gz -C /usr/local/
mv /usr/local/mysql-proxy-0.8.5-linux-glibc2.3-x86-64bit/ /usr/local/mysql-proxy
useradd -r mysql-proxy
```

配置环境变量

```
echo 'export PATH=$PATH:/usr/local/mysql-proxy/bin/' >>/etc/profile
source /etc/profile
```

启动mysql-proxy

```
mysql-proxy --daemon --log-level=debug --user=mysql-proxy --keepalive --log-file=/var/log/mysql-proxy.log --plugins="proxy" --proxy-backend-addresses="172.16.1.128:3306" --proxy-read-only-backend-addresses="172.16.1.129:3306" --proxy-lua-script="/usr/local/mysql-proxy/share/doc/mysql-proxy/rw-splitting.lua" --plugins=admin --admin-username="admin" --admin-password="admin" --admin-lua-script="/usr/local/mysql-proxy/lib/mysql-proxy/lua/admin.lua"
```

MYSQL-Proxy启动后，服务器端会启动4040和4041两个端口，其中4040为proxy代理端口用于WEB应用连接，4041为管理端口用于SA或者DBA管理。
登录4041管理端口查看读写分离状态，命令如下：

```
mysql -h 172.16.1.131 -uadmin -padmin -P 4041
```

以4041端口登录之后执行select命令，如果state状态都为UP，则读写分离部署成功

```
select * from backends;
```

![UP.png][3]

[3]: ../images/485996586.png

