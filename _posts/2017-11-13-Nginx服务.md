# linux服务篇（Nginx服务）

Nginx [engine x]是Igor Sysoev编写的一个HTTP和反向代理服务器，另外它也可以作为邮件代理服务器。 

nginx由内核和模块组成，其中内核的设计非常的微小和简洁，完成的工作也非常简单，仅仅是通过查找配置文件将客户端请求映射到一个location block（location是Nginx配置中的一个指令，用于URL匹配），而在这个location中所配置的每个指令将会启动不同的模块去完成相应的工作。

NGINX优点：

1. 高并发响应性能非常好，官方Nginx处理静态文件并发5W/s；
2. 反向代理性能非常好（可用于负载均衡）；
3. 内存和cpu占用率低；（是apache的1/5-1/10）
4. 对php可使用cgi或者fastcgi方式。

NGINX源码安装（官方下载源码包,在此使用1.4.2版本安装）

```
useradd  -r www
tar zxvf nginx-1.4.2.tar.gz
cd nginx-1.4.2
./configure --user=www --group=www --prefix=/usr/local/nginx --with-http_stub_status_module --with-http_ssl_module
(添加ssl模块要安装openssl ‘yum install openssl* -y’)
make && make install 
```

nginx安装完毕。

检查nginx配置文件是否正确，返回OK即正确。

```
/usr/local/nginx/sbin/nginx -t
```

启动nginx命令

```
/usr/local/nginx/sbin/nginx
```

关闭nginx杀死进程即可

```
pkill nginx
```

nginx常用配置参数详解

```
user www;
```

使用www用户启动进程

```
pid        logs/nginx.pid;
```

指定PID存放路径

```
#error_log  logs/error.log;
```

指定错误日志路径

```
gzip on;
```

开启压缩

```
worker_processes 1;
```

nginx进程数，建议按照CPU核心数来指定，一般为它的倍数

```
worker_cpu_affinity 0000001
```

为每个进程分配CPU

```
worker_rlimit_nofile 1024
```

指当一个nginx进程打开的最多文件描述符数目理论值应该是最多打开文件数与nginx进程数相除（即单个进程打开文件最大数），但是nginx分配请求并不是那么均匀，所以最好与打开文件最大数保持一致

```
use epoll 
```

使用epoll的I/O模型

```
worker_connections 102400
```

每个进程允许的最多连接数

```
keepalive_timeout 60
```

keepalive超时时间，客户端到服务器的连接持续有效时间，当出现对服务器的后继请求时，keepalive-timeout功能可避免建立或重新建立连接

```
client header buffer size 4k;
```

客户端请求头部的缓冲区大小，这个可根据系统分页大小来设置，一般一个请求的头部大小不会超过1K，不过由于一般系统分页都要大于1k，所以这里设置为分页大小。分页大小可以用命令getconf PAGESIZE取得。

```
open_file_cache max=102400 inactive=20s;
```

为打开文件指定缓存，默认是没有启用的，MAX指定缓存数量建议和打开文件数一直，inactive是指经过多长时间文件没被请求后删除缓存。

```
open_file_cache_valid 30s;
```

指多长时间检查一次缓存的有效信息

```
open_file_cache_min_uses 1;
```

open_file_cache指令中的inactive参数时间内文件的最少使用次数，如果超过这个数字，文件描述符一直是在缓存中打开的，如上例，如果有一个文件在inactive时间内一次没被使用，它将被移除。

NGINX服务器多数应用于网页静态服务器、虚拟主机、代理服务器等，还可与其他WEB服务器一同使用，实现动静分离，负载均衡。



## nginx查看工作状态模块http_stub_status_module

Nginx中的stub_status模块主要用于查看Nginx的工作状态信息.

首先在编译的时候加上**--with-http_stub_status_module**这句来添加监控模块。该模块在默认编译的情况下是不会编译进nginx的。

 编译成功之后开始配置nginx，在server块中添加一个localtion:

```
localtion /nginxstatus{
          stub_status on;
          access_log /var/log/nginx/nginx.status.log;
          allow 0.0.0.0;#允许的IP
          deny all;
}
```

查看nginx运行状态信息URL：**\http://本机IP/nginxstatus**
同时也可以做用户认证，在localtion块中添加：

```
localtion /nginxstatus{
          stub_status on;
          access_log /var/log/nginx/nginx.status.log;
          auth_basic "nginxstatus";
	  auth_basic_user_file "/usr/local/nginx/htpasswd";
}
```

添加认证用户命令,并指定存放用户信息文件目录

```
htpasswd -c /usr/local/nginx/htpasswd admin
```

重启nginx服务后访问**\http://本机IP/nginxstatus**，输入用户名密码即可查看nginx运行状态。

​    

**nginx数据状态详解**

```
active connection : 当前活跃的连接数
server accepts handled requiests :  处理n个连接   成功创建n次握手  共处理n个请求
reading  ：      读取到客户端的头文件次数；
writing  ：      返回给客户端的头文件次数；
waiting  :       已经处理完，等待下次请求的驻留连接数；
```



