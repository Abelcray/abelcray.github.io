# Ansible自动化运维工具

<!--markdown-->> 自动化运维工具有很多，例如：PSSH、Puppet、Chef、SaltStack、Ansible等等。但目前使用较多的自动化配置工具有Puppet、Ansible和Saltstack。

> Puppet是早期的linux自动化运维工具，基于Ruby语言编写，采用C/S模式，需要安装服务端和客户端；Saltstack是基于Python编写的，加入了MQ消息同步，也属于C/S模式。

> Ansible基于Python语言开发，采用SSH远程管理，不需要客户端，但由于是SSH服务连接，执行效率较Saltstack而言相对慢一点。

本篇文章以安装和使用Ansible为主。

优点：

1. 轻量级，更新时只需要在操作机上进行一次更新；
2. 采用SSH协议；
3. 不需要客户端安装agent;
4. 批量任务执行可以写成脚本，而且不用分发到远程就可执行；
5. 使用python编写，维护简单；
6. 支持sudo普通用户命令；
7. 去中心化管理。

安装配置：

安装EPEL扩展源

```
rpm -Uvh http://mirrors.yun-idc.com/epel/7/x86_64/e/epel-release-7-9.noarch.rpm 
yum install epel-release -y
```

安装Ansilbe

```
yum install ansible -y
```

Ansible默认配置目录为：/etc/ansible/,其中hosts文件为被管理主机IP或者主机名列表，ansible.cfg为主配置文件，roles为角色或者插件路径，默认改目录为空。

由于Ansible管理主机通过SSH服务，在登录远程主机管理时需要输入远程主机的用户名密码，也可以加入-k 参数手动输入密码或者配置SSH免密码登录。



ansible的配置文件优先级 定义相关的属性

```
/etc/ansible/ansible.cfg   优先级第三
```

```
~/.ansible.cfg   家目录下的配置文件优先级第二
```

```
./ansible.cfg     当前目录下优先级最高

ansible --version可查看目前哪个配置文件生效
```



Ansible常用命令参数

```
-v,–verbose
```

打印详细模式；

```
-i PATH,–inventory=PATH
```

指定host文件路径；

```
-f NUM,–forks=NUM
```

指定fork开启同步进程的个数，默认5；

```
-m NAME,–module-name=NAME   	
```

指定module名称，默认模块command；

```
-a MODULE_ARGS      
```

module模块的参数或者命令；

```
-k,–ask-pass    
```

输入远程被管理端密码；

```
–sudo       
```

基于sudo用户执行；

```
-K,–ask-sudo-pass       
```

提示输入sudo密码与sudo一起使用；

```
-u USERNAME,–user=USERNAME  
```

指定移动端的执行用户；

```
-C,–check      
```

测试执行过程，不改变真实内容，相当于预演；

```
-T TIMEOUT
```

执行命令超时时间，默认为10秒；

```
--version 	
```

查看Ansible软件版本信息。



Ansible基于多模块管理，常用的管理模块包括：**command、shell、script、yum、copy、File、async、docker、cron、mysql_user、ping、sysctl、user、acl、add_host、easy_install、haproxy**等（可通过ansible-doc -l|more来查看ansible支持的模块）

其中setup模块为gather facts模块，可用来做资产信息收集，具体各个模块使用方法可以通过ansible-doc module_name来查看每个模块的帮助文档。

可结合ansible-galaxy编写roles、ansible-vault加密等做配置管理。

关于性能优化方面

- 根据实际情况调整并行任务数量
- 增加redis缓存facts信息，提高任务下发效率或者关闭facts
- 编写playbook时增加委派功能
- 异步下发任务或者滚动更新



