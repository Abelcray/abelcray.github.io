## NTP时间服务器
<!--markdown-->   在局域网内搭建一台NTP时间服务器可以很方便的为局域网中的服务器、交换机等网络设备进行校时。NTP服务通信采用UDP协议，端口号为123。
    
首先开启防火墙的123端口

安装NTP服务
    

```
yum install ntp -y
```

设置开机启动

```
systemctl enable ntpd
```

配置文件/etc/ntp.conf中常用配置参数

```
server ip或域名 [prefer]
```

ip或域名为上一级NTP服务器，如果在最后加上关键字prefer，表示当前NTP服务器主要以该主机时间进行校准。

```
restrict  ip网段  mask  掩码  nomodify notrap
```

restrict主要用来设置NTP可被访问的权限，其中IP地址既可以是IP地址，也可以是关键字default(表示所有IP)。

```
server 127.127.1.0 
fudge 127.127.1.0 stratum 8 
```

表示可以把本地时间当做ntp服务的校准时间。

启动NTP服务

```
systemctl start ntpd
```

查看NTP服务的运行状态命令
    

```
watch ntpq -p 
```

客户端同步命令
    

```
ntpdate 服务器IP或者域名 参数-d可以查看同步时的详细信息用于排错。
```

## NFS共享服务器

## <!--markdown-->NFS简介

> NFS 是Network File System的缩写，即网络文件系统。一种使用于分散式文件系统的协定，由Sun公司开发，于1984年向外公布。功能是通过网络让不同的机器、不同的操作系统能够彼此分享个别的数据，让应用程序在客户端通过网络访问位于服务器磁盘中的数据，是在类Unix系统间实现磁盘文件共享的一种方法。

> NFS在文件传送或信息传送过程中依赖于RPC协议。RPC，远程过程调用 (Remote Procedure Call) 是能使客户端执行其他系统中程序的一种机制。NFS本身是没有提供信息传输的协议和功能的，但NFS却能让我们通过网络进行资料的分享，这是因为NFS使用了一些其它的传输协议。而这些传输协议用到这个RPC功能的。可以说NFS本身就是使用RPC的一个程序。或者说NFS也是一个RPC SERVER。所以只要用到NFS的地方都要启动RPC服务，不论是NFS SERVER或者NFS CLIENT。这样SERVER和CLIENT才能通过RPC来实现PROGRAM PORT的对应。可以这么理解RPC和NFS的关系：NFS是一个文件系统，而RPC是负责信息的传输。

## 安装NFS

```
yum install nfs-utils rpcbind -y
nfs的配置文件为/etc/exports默认为空
vi /etc/exports
/data 192.168.65.0/24(rw,no_root_squash,sync)
```

属性详解

```
ro                      只读访问 
rw                      读写访问 
sync                    所有数据在请求时写入共享 
all_squash              共享文件的UID和GID映射匿名用户anonymous，适合公用目录。 
no_all_squash           保留共享文件的UID和GID（默认） 
root_squash             root用户的所有请求映射成如anonymous用户一样的权限（默认） 
no_root_squash           root用户具有根目录的完全管理访问权限
```



```
启动服务 systemctl restart nfs
```

客户端挂载命令
     

```
mount -t nfs 192.168.65.128:/data /test   
```

在部署过程中出现了一个错误
    

```
mount.nfs: access denied by server while mounting 192.168.65.128:/data
```

后经过查找问题发现如果端口号大于1024，则需要将 insecure 参数加入到配置文件（/etc/exports）相关选项中mount客户端才能正常工作:

```
/data 192.168.65.0/24(insecure,rw,no_root_squash,sync)
```

加上参数之后保存配置文件，重启服务问题就解决了。

## vsftpd服务部署

<!--markdown-->> vsftpd 是“very secure FTP daemon”的缩写，安全性是它的一个最大的特点。vsftpd 是一个 UNIX类操作系统上运行的服务的名字，它可以运行在诸如 Linux、BSD、Solaris、HP-UNIX等系统上面，是一个完全免费的、开放源代码的ftp服务器软件，支持很多其他的 FTP服务器所不支持的特征。比如：非常高的安全性需求、带宽限制、良好的可伸缩性、可创建虚拟用户、支持IPv6、速率高等。

首先要开启防火墙的20、21端口

firewall-cmd --zone=public --add-port=20/tcp --permanent
firewall-cmd --zone=public --add-port=21/tcp --permanent
firewall-cmd --reload

可用firewall-cmd --list-port来查看端口是否开启

或者关闭防火墙systemctl stop firewalld 

关闭seliux 

setenforce 0 (永久关闭`sed -i sed '/SELINUX/s/enforcing/disabled/g' /etc/sysconfig/selinux`)

常用配置详解

```
anonymous_enable=NO
```

 禁止匿名用户访问

```
local_enable=YES
```

 允许本地用户登录FTP

```
anon_root=/var/ftp
```

 使用匿名登陆时所登入的目录，默认为/var/pub。（注意：FTP目录不能是777的权限属性，即匿名用户的家目录不能有777的权限。）

```
write_enable=YES
```

 允许登陆用户在FTP目录有写入的权限

```
anon_upload_enable=YES
```

 允许匿名用户有上传文件的权限，在weite_enable=YES时生效

```
anon_world_readable_only=YES
```

 允许匿名用户有下载文件的权限

```
anon_mkdir_write_enable=YES
```

 允许匿名用户有创建目录的权限

```
chown_uploads=NO
```

 设置是否改变匿名用户上传文件的属主

```
chown_username=username
```

 设置匿名用户上传文件的属主名

```
deny_email_enable=NO
```

 在使用匿名登陆时会要求输入email_address,若输入的email address在banner_emails文件内，则不允许进入，默认为NO

```
banned_email_file=/etc/vsftpd/banned_emails
```

 指定deny_email的档案目录

```
local_root=/home/username
```

 当本地用户登陆时，将被更换到指定的目录下，默认为个用户的家目录

```
file_open_mode=0755
```

 本地用户上传文件后的文件权限，与chmod所使用的数值相同。默认值为0666

```
dirmessage_enable=YES
```

 启用欢迎语，当开启此项设置的时候，当用户第一次进入到目录的时候，会检查改目录下是否有.message这个文件，如果有，则会显示该文件的内容。

```
message_file=.message
```

 设置目录消息文件，可将要显示的信息写入该文件。默认值为.message。

```
banner_file=/etc/vsftpd/banner
```

 当使用者登陆时，会显示该设定所在的文件内容，通常是欢迎语或者说明。默认为无，如果欢迎信息较多，则使用改配置项。

```
ftpd_banner=Welcome to FTP server
```

 定义简单的欢迎语，banner_file是文件的形式，而ftpd_banner则是字符串的形式。预设为无。

```
local_umask=022
```

 设置本地用户的文件生成掩码为022，默认系统掩码是077

```
dirmessage_enable=YES
```

 激活目录信息，当远程用户更改目录时，将出现提示信息

```
xferlog_enable=YES
```

 启用上传和下载日志功能

```
connect_from_port_20=YES
```

 启用FTP数据端口的连接请求

```
xferlog_file=/var/log/vsftpd.log
```

 指定日志文件路径

```
xferlog_std_format=YES
```

 是否使用标准的ftpd xferlog日志文件格式 

```
ascii_upload_enable=YES
```

 启用ASCII模式上传数据

```
ascii_download_enable=YES
```

 启用ASCII模式下载数据

```
listen=YES
```

 使vsftpd处于独立启动监听端口模式

```
max_clients=0
```

 设置FTP服务器允许的最大连接数，0为不限制。

```
max_per_ip=0
```

 设置每个IP允许与FTP服务器同时建立连接的数目，0为不限制。

```
setproctitle_enable=NO
```

 设置每个与FTP服务器的连接，是否以不同的进程表现出来。默认值为NO，此时使用ps aux |grep ftp只会有一个vsftpd的进程。若设置为YES，则每个连接都会有一个vsftpd的进程。

控制用户访问：
通过/etc目录下的vsftpd.user_list和ftpusers文件来实现。

```
userlist_file=/etc/vsftpd.user_list
```

 控制用户访问FTP的文件，里面写着用户名称。一个用户名称一行。

```
userlist_enable=YES/NO（NO）
```

 是否启用vsftpd.user_list文件。

```
userlist_deny=YES/NO（YES）
```

 决定vsftpd.user_list文件中的用户是否能够访问FTP服务器。若设置为YES，则vsftpd.user_list文件中的用户不允许访问FTP，若设置为NO，则只有vsftpd.user_list文件中的用户才能访问FTP。
/etc/vsftpd/ftpusers文件专门用于定义不允许访问FTP服务器的用户列表

（注意:如果userlist_enable=YES,userlist_deny=NO,此时如果在vsftpd.user_list和ftpusers中都有某个用户时，那么这个用户是不能够访问FTP的，即ftpusers的优先级要高）。默认情况下vsftpd.user_list和ftpusers，这两个文件已经预设置了一些不允许访问FTP服务器的系统内部账户。如果系统没有这两个文件，那么新建这两个文件，将用户添加进去即可。

控制主机访问：
开启tcp_wrappers后通过/etc/hosts.allow和/etc/hosts.deny文件来实现。

```
tcp_wrappers=YES
```

 使用tcp_wrappers作为主机访问控制方式；设置vsftpd是否与tcp wrapper相结合来进行主机的访问控制。默认值为YES。如果启用，则vsftpd服务器会检查/etc/hosts.allow 和/etc/hosts.deny 中的设置，来决定请求连接的主机，是否允许访问该FTP服务器。这两个文件可以起到简易的防火墙功能。

控制用户是否允许切换到上级目录：
在默认配置下，本地用户登入FTP后可以使用cd命令切换到其他目录，这样会对系统带来安全隐患。可以通过一下三个配置文件来控制用户切换目录。

```
chroot_list_enable=YES
```

 设置是否启用chroot_list_file配置指定的用户列表文件。默认为NO

```
chroot_list_file=/etc/vsftod.chroot_list
```

 用于指定用户列表文件，该文件用于控制那些用户可以切换到用户家目录的上级目录。

```
chroot_local_user=YES
```

 用于设置指定用户列表文件中的用户是否允许切换到上级目录。默认值为NO

```
anon_max_rate=0
```

 设置匿名登陆者使用的最大传输速度，单位为B/s，0表示不限速。

```
local_max_rate=0
```

 本地用户使用的最大传输速度，单位为B/s,0表示不限速。

```
accept_timeout=60
```

 设置建立FTP连接的超时时间，单位为秒。

```
connect_timeout=60
```

 PORT方式下建立数据连接的超时时间，单位为秒。

```
date_connection_timeout=120
```

 设置建立FTP数据连接的超时时间，单位为秒。

```
idle_session_timeout=300
```

 设置多长时间不对FTP服务器进行任何操作，则断开该FTP连接，单位为秒。

```
user_config_dir=/etc/vsftpd/userconf
```

 自定义单个用户配置文件目录，设置用户配置文件所在的目录。当设置了该配置项后，用户登陆服务器后，系统就会到/etc/vsftpd/userconf目录下，读取与当前用户名相同的文件，并根据文件中的配置命令，对当前用户进行更进一步的配置。
例如：定义user_config_dir=/etc/vsftpd/userconf，且主机上有使用者 test1,test2，那么我们就在user_config_dir 的目录新增文件名为test1和test2两个文件。若是test1 登入，则会读取user_config_dir 下的test1 这个档案内的设定。默认值为无。利用用户配置文件，可以实现对不同用户进行访问速度的控制，在各用户配置文件中定义local_max_rate=XX，即可。

```
pasv_enable=YES
```

 若设置为YES，则使用PASV工作模式；若设置为NO，则使用PORT模式。默认值为YES，即使用PASV工作模式。

```
pasv_max_port=0
```

 在PASV工作模式下，数据连接可以使用的端口范围的最大端口，0为任意端口。

```
pasv_min_port=0
```

 在PASV工作模式下，数据连接可以使用的端口范围的最小端口，0为任意端口。

虚拟用户常用配置参数：
虚拟用户使用PAM认证方式。

```
pam_service_name=vsftpd
```

设置PAM使用的名称，默认值为/etc/pam.d/vsftpd。

```
guest_enable= YES/NO（NO）
```

启用虚拟用户。默认值为NO。

```
guest_username=ftp
```

这里用来映射虚拟用户。默认值为ftp。

```
virtual_use_local_privs=NO
```

当该参数激活（YES）时，虚拟用户使用与本地用户相同的权限。当此参数关闭（NO）时，虚拟用户使用与匿名用户相同的权限。默认情况下此参数是关闭的（NO）。

其他设置：

```
text_userdb_names= YES/NO（NO）
```

设置在执行ls –la之类的命令时，是显示UID、GID还是显示出具体的用户名和组名。默认值为NO，即以UID和GID方式显示。若希望显示用户名和组名，则设置为YES。

```
ls_recurse_enable=YES/NO（NO）
```

若是启用此功能，则允许登入者使用ls –R（可以查看当前目录下子目录中的文件）这个指令。默认值为NO。

```
hide_ids=YES/NO（NO）
```

如果启用此功能，所有文件的拥有者与群组都为ftp，也就是使用者登入使用ls -al之类的指令，所看到的文件拥有者跟群组均为ftp。默认值为关闭。

```
download_enable=YES/NO（YES）
```

如果设置为NO，所有的文件都不能下载到本地，文件夹不受影响。默认值为YES。

安装vsftpd软件

yum install vsftpd* -y

配置文件路径/etc/vsftpd/vsftp.conf

配置vsftpd虚拟用户认证：

安装认证模块 `yum  install  pam*  libdb-utils libdb* --skip-broken  –y` 

1.创建并生成vsftpd用户数据库文件

```
touch  /etc/vsftpd/ftpusers.txt
cat >/etc/vsftpd/ftpusers.txt<< EOF
user1
123
user2
456
user3
789
EOF
```

根据ftpuser.txt生成用户数据库文件

```
db_load -T -t hash -f /etc/vsftpd/ftpusers.txt /etc/vsftpd/vsftpd_login.db
```

修改数据库文件权限为700

```
chmod 700 /etc/vsftpd/vsftpd_login.db
```

2.配置PAM验证文件,在文件内容最上方添加两行内容并用 注释其他的内容。

```
vi /etc/pam.d/vsftpd
auth      required        pam_userdb.so   db=/etc/vsftpd/vsftpd_login
account   required        pam_userdb.so   db=/etc/vsftpd/vsftpd_login
```

3.创建虚拟用户所映射的系统用户

```
useradd    -s   /sbin/nologin    ftpuser
```

4.在配置文件中添加虚拟用户配置参数

```
pam_service_name=vsftpd
guest_enable=YES
guest_username=ftpuser
user_config_dir=/etc/vsftpd/vsftpd_user_conf
virtual_use_local_privs=YES
```

5.创建虚拟用户的配置文件主目录

```
mkdir -p /etc/vsftpd/vsftpd_user_conf
```

6.为虚拟用户user1、user2、user3创建配置文件，配置私有目录路径

```
vi /etc/vsftpd/vsftpd_user_conf/user1
local_root=/home/ftpuser/user1
write_enable=YES
anon_world_readable_only=YES
anon_upload_enable=YES
anon_mkdir_write_enable=YES
anon_other_write_enable=YES

vi /etc/vsftpd/vsftpd_user_conf/user2
local_root=/home/ftpuser/user2
write_enable=YES
anon_world_readable_only=YES
anon_upload_enable=YES
anon_mkdir_write_enable=YES
anon_other_write_enable=YES

vi /etc/vsftpd/vsftpd_user_conf/user3
local_root=/home/ftpuser/user3
write_enable=YES
anon_world_readable_only=YES
anon_upload_enable=YES
anon_mkdir_write_enable=YES
anon_other_write_enable=YES
```

7.创建虚拟用户的私有目录

```
mkdir -p /home/ftpuser/user{1..3} ;chown -R ftpuser:ftpuser /home/ftpuser
```

8.重启服务 

```
systemctl restart vsftpd
```

## Apache WEB服务

<!--markdown-->> apache是目前主流的WEB服务器，译名为A Patchy Server,顾名思义它是一个多模块化的服务器，尽管nginx的诞生对它的地位有所撼动，但是这并不妨碍它仍然被成为目前最流行的WEB服务器之一。

apache的特性：

1. 进程控制
2. 事先创建的进程有数目限制，按需进行
3. 模块化，内核小
4. 支持虚拟主机
5. 支持https
6. 支持用户认证
7. 基于IP或主机名的ACL访问控制
8. 支持每目录的访问控制
9. 支持URL重写

apache工作原理分为三种：Prefork MPM、Worker MPM、Event MPM

Prefork MPM是默认的工作方式：
采用预派生子进程的方式，使用单独的子进程来处理不同的请求，进城之间是彼此独立的；并且会根据并发请求数量生成更多的子进程。

这种方式不必在请求到来时再产生新的进程，从而减小了系统开销以增加性能，但由于是采用多进程的方式来提供对外服务的，每个进程所占内存资源也相对较高。

配置参数

```
StartService   8    服务器启动是默认子进程数
MinSpareServers  5    最小空闲进程数
MaxSpareServers  20    最大空闲进程数
ServerLimit  256    系统允许apache创建的最大进程数
MAXClient  256    允许连接的最大客户端数量
MaxRequestsPerChild  4000    一个进程最多响应多少次后被杀死（0为不杀死）
```

------

Worker MPM是线程化、多进程的模式：
每个进程可以生成多个线程，每个线程处理一个请求，由一个单独的控制进程复制子进程的建立。

这种模式可以处理更多的HTTP请求，系统资源的开销也要小于基于Prefork模式；但如果一个进程中的某一个线程挂掉了，那整个进程都会挂掉。

配置参数

```
StartServers  8    服务器启动默认子进程数
MaxClients  300    最大客户端连接数
MinSpareThreads  25    最小空闲进程数
MaxSpareThreads  75    最大空闲进程数
ThreadsPerChild  25    单个进程生成多少线程
MaxRequestsPerChild  10000    一个进程最多响应多少次请求
```

Event MPM模式是对Prefork模式的优化，但目前不支持https。

apache服务安装

```
yum install httpd -y
```

(yum安装是最快的安装方式，生产环境中多使用编译安装，请解决依赖关系)

配置文件路径

```
/etc/httpd/conf/httpd.conf (主配置文件)

/etc/httpd/conf.d/*.conf (include文件)

/etc/httpd/conf.modules.d/ (apache2.4通用，配置文件模块化)

/usr/lib64/httpd/modules/ (模块存放目录)

/var/www/html/ (网站根目录)

/var/log/httpd/ (日志存放目录)

/usr/share/doc/httpd-2.4.6/  (yum方式安装apache的配置文件模板目录)
```

常用配置文件详解

```
 ServerTokens OS
```

这个项目仅仅是在告知客户端我们服务器的版本和操作系统而已，不需要改动他
如果不在乎你的系统信息被远程用户查询到，则可以将这个项目注释掉（不建议）

```
ServerRoot  "/etc/httpd"
```

服务器设置的最顶层目录，有点类似于chroot那种感觉。包括logs , modules等

```
PidFile run/httpd.pid
```

放置PID的文件

```
Timeout 60
```

不论接收或发送，当持续连接等待超过60秒则该次连接就中断，一般来说，此数值在300秒左右即可，不需要修改这个原始值
KeepAlive Off
这里表示是否允许持续性的连接，也就是一个TCP连接可以具有多个文件资料传送的要求，建议开启

```
MaxKeepAliveRequests 100
```

可以将默认的100改成500或更高，与上一个设置的值KeepAlive有关，当KeepAlive的值设置为On的时候，这个数值可以决定该次连接能够传输的最大传输数量。为了提高效率则可以改大一点。0代表不限制

```
KeepAliveTimeout 65
```

在KeepAlive设置为“On”的情况下，该次连接在最后一次传输后等待延迟的秒数当超过该秒数的时候该连接中断。保持默认值15即可，如果设置的值太高（等待时间较长），在较忙碌的系统上面将会有较多的Apache程序占用资源，可能有效率方面的问题。

```
<IfModule prefork.c>
StartServers      8				启动Apache的时候，唤醒几个PID来处理服务的。
MinSpareServers   5				最小预备使用的PID数量
MaxSpareServers   20				最大预备使用的PID数量
ServerLimit      4096				服务器的限制
MaxClients      4096				最多可以有多少个客户端同时连接到Apache
</IfModule>
```

最大的同时连接数量，也就是process不会超过这一数值。
这个MaxClients设置值可以控制同时连上www服务器的总连接要求数量，
也可以将其看作是最高实时在线人数。不过要注意的是：这个值并非越大越好
因为他会消耗物理内存（与process有关），所以如果你设置太高导致超出物理内存能够容许的范围，那么效率就会大大降低（因为会跑SWAP），此外，MaxClients也在Apache编译的时候就指定最大值了，所以无法超出系统最大值，除非重新编译Apache

```
MaxRequestsPerChild  4000
```

每个程序能够提供的最大传输次数要求。举例来说：如果有个用户连上服务器之后，要求数百个网页，当他的要求数量超过这个值的时候则该程序会被丢弃，另外切换一个新程序。这个设置可以有效地管理每个process在系统上存活的时间。

```
<IfModule worker.c>
StartServers        8
MaxClients         4000
MinSpareThreads     25
MaxSpareThreads     75 
ThreadsPerChild     75
MaxRequestsPerChild  0
</IfModule>
```

worker模式性能相对prefork要好一些，默认的项目配置对于一般中小型网站来说已经很够用了，不过如果网站的流量比较大，也可以修订一下里面的数值。这两个模块都是用在提供用户连接资源，设置的数值越大代表系统会启动越多的程序来提供Apache的服务，反映速度就比较快

```
Redhat和CentOS将这两个模块分别放到了不同的执行文件中，分别是
	|- /usr/sbin/httpd  使用prefork模块
	|- /usr/sbin/httpd.worker  使用worker模块
/etc/sysconfig/httpd这个文件决定了Apache使用哪一个模块，可以通过修改这个文件来切换不同的工作模式。

LoadModule cgi_module modules/mod_cgi.so
LoadModule version_module modules/mod_version.so
```

Apache提供了非常多的模块供我们使用，以上就是加载的模块

```
Include conf.d/*.conf
ServerAdmin root@localhost
```

系统管理员的邮箱，当网站出现问题的时候，错误信息会显示的联系邮箱

```
DocumentRoot   "/var/www/html"
```

指定放置首页的目录

```
<Directory />
    Options FollowSymLinks
    AllowOverride None
</Directory>
```

Directory指定后面的路径是系统中的绝对路径
这个设置是针对www服务器的默认环境而来的，因为是针对“/”的设置
建议保留上面的默认值

```
<Directory "/var/www/html">
```

使用Directory指定了一个绝对路径的目录

```
Options -Indexes FollowSymLinks
```

Options（目录参数）此设置值表示在这个目录内能够让Apache进行的操作，也就是针对Apache的程序的权限设置。
主要的参数值有：

```
#	Indexes：如果在此目录下找不到首页文件（默认为index.html）时，就显示整个目录下的文件名，至于首页文件名则与DirectoryIndex设置的值有关，建议注释掉Indexes。
#	FollowSymLinks：这是Fllow Symolic Links的缩写，字面意义是让连接文件可以生效。我们知道首页的目录是在/var/www/html，既然是WWW的根目录，理论上就像被chroot，一般说来说被chroot的程序无法离开其目录，也就是说，默认的情况下，你在/var/www/html下面的连接文件只要链接到非此目录的其他地方，则该连接文件默认是失效的。但是使用这个设置可以让链接有效的离开本目录
#	ExecCGI：让此目录具有执行CGI的权限，非常重要。举例来说，OpenWebMail使用了很多Perl程序，你要让OpenWebMail可以执行，就需要在该程序所在目录拥有ExecCGI的权限才行。但是要注意：不要让所有的目录均可以使用ExecCGI
#	Includes：让一些Server-Side Include程序可以运行。建议可以加上去MultiViews：这个有点像是多国语言的支持，与语言数据有关。在错误信息的回报内容中最常见，在同一台主机中，可以依据客户端的语言而给予不同的语言显示。默认在回报信息中存在，你可以检查一下/var/www/error/目录下的数据。

AllowOverride None
```

允许覆盖参数功能，表示是否允许额外配置文件.htaccess的某些参数覆盖。我们可以在httpd.conf内设置好所有的权限，不过这样一来，若用户自己的个人网页想要修改权限时将会对管理员造成困扰。因此，Apache默认可以让用户以目录下的.htaccess文件内覆盖<Direcoty>内的某些功能参数。这个项目则是在规定.htaccess可以覆盖的权限类型有哪些。
常见的有以下几种：

```
#	ALL：全部的权限均可以覆盖
#	AuthConfig：仅有网页认证（帐号与密码）可以覆盖
#	Indexes：仅允许Indexes方面的覆盖
#	Limits：允许用户利用Allow、Deny与Order管理可浏览的权限
#	None：不可覆盖，也就是让.htaccess文件失效，使用.htaccess会严重影响到Apache的性能，如果不是特殊需要，建议关闭

Order allow,deny
Allow from all
```

能否登陆浏览的权限，决定此目录是否可被Apache的PID所浏览的权限设置。能否被浏览主要有两种判断的方式：

```
#	deny,allow  以deny优先处理，但没有写入规则的默认为allow
#	allow,deny  以allow为优先处理，但是没有写入规则的默认为deny
```

所以在默认的情况下，因为是allow,deny 所以默认为deny（不可浏览），不过在下一行有个allow from all，allow优先处理，因此全部客户端均可浏览

虚拟主机配置

虚拟主机可以基于多种方式：基于IP、基于端口、基于域名、基于路径、基于HTTPS

基于域名的配置参数

```
NameVirtualHost *:80
<VirtualHost *:80>
    ServerAdmin root@localhost.com
    DocumentRoot  "/var/www/html/test1"
    ServerName www.test1.com
  <Directory "/var/www/html/test1">
    AllowOverride All
    Options -Indexes FollowSymLinks
    Order allow,deny
    Allow from all
  </Directory>
    ErrorLog  logs/error_log
    CustomLog logs/access_log common
</VirtualHost>
<VirtualHost *:80>
    ServerAdmin root@localhost.com
    DocumentRoot "/var/www/html/test2"
    ServerName www.test2.com
  <Directory "/var/www/html/test2">
    AllowOverride All
    Options -Indexes FollowSymLinks
    Order allow,deny
Allow from all
  </Directory>
    ErrorLog  logs/error_log
    CustomLog logs/access_log common
</VirtualHost>
```

修改完配置文件后重启服务生效systemctl restart httpd

注：CentOS7以上版本对apache的配置文件进行了模块化分类，但具体功能没变，以上配置参数均为CentOS6中的参数。


## MYSQL服务

<!--markdown-->> MYSQL是一个关系型数据库，在Orcale收购之后，分为企业版和社区版；MariaDB数据库管理系统是MYSQL的一个分支，主要由开源社区在维护，MariaDB完全兼容MYSQL，是MYSQL很好的替代品。

MYSQL的数据库引擎有很多，但常用的数据库引擎为MyIsam和InnoDB引擎。（MYSQL在5.5版本之后已经把InnoDB作为默认引擎。）

MyISAM类型的数据库表强调的是性能，它的执行速度比InnoDB类型更快，但不提供事务支持，不支持外键，如果大量的执行SELECT操作，MySIAM是更好的选择，支持表锁。

InnoDB提供事务支持、外部键、行级锁等高级数据库功能，执行大量的INSERT或UPDATE，如果对并发写入的要求高，那么InnoDB就是首选了。

MYSQLyum安装

```
yum install mysql mysql-devel mysql-server -y
（CENTOS7：yum install mariadb mariadb-server mariadb-devel -y）
```

MYSQL源码安装(MYSQL5.7.20版本)*以下软件均下载到本地*

安装依赖

```
yum install cmake ncurses ncurses-devel gcc gcc-c++ -y
```

添加BOOST库

```
tar zxvf boost_1_59_0.tar.gz -C /usr/local
```

解压mysql源码包

```
tar zxvf mysql-5.7.20.tar.gz 
```

源码安装前准备工作

创建用户

```
groupadd mysql
useradd -r -g mysql -s /bin/false mysql
```

创建数据目录

```
mkdir -p /data/mysql
chown -R mysql:mysql /data/mysql
```

源码安装

```
cd mysql-5.7.20
cmake .  \                                  预编译
 -DCMAKE_INSTALL_PREFIX=/usr/local/mysql \  指定安装目录
 -DMYSQL_DATADIR=/data/mysql \              指定数据目录
 -DSYSCONFDIR=/etc \                        指定配置目录
 -DMYSQL_USER=mysql \                       指定启动用户
 -DWITH_MYISAM_STORAGE_ENGINE=1 \           启用MYISAM引擎
 -DWITH_INNOBASE_STORAGE_ENGINE=1 \         启用INNODB引擎
 -DWITH_ARCHIVE_STORAGE_ENGINE=1 \          启用ARCHIVE引擎
 -DWITH_MEMORY_STORAGE_ENGINE=1 \           启用MEMORY引擎
 -DWITH_READLINE=1 \                        启用快捷键功能
 -DMYSQL_UNIX_ADDR=/tmp/mysql.sock \        通信设置
 -DMYSQL_TCP_PORT=3306 \                    指定服务端口
 -DENABLED_LOCAL_INFILE=1 \                 启用本地
 -DENABLE_DOWNLOADS=1 \                     允许下载可选文件
 -DWITH_PARTITION_STORAGE_ENGINE=1 \        启用partition引擎
 -DEXTRA_CHARSETS=all \                     安装所有扩展字符集
 -DDEFAULT_CHARSET=utf8 \                   指定默认字符集
 -DDEFAULT_COLLATION=utf8_general_ci \      检验字符
 -DWITH_DEBUG=0 \                            关闭调试模式
 -DMYSQL_MAINTAINER_MODE=0 \                 关闭mysql维护模式
 -DDOWNLOAD_BOOST=1 \                        允许下载更新boost库
 -DWITH_BOOST=/usr/local/boost_1_59_0        指定boost库路径
 make                                        编译
 make install                                安装
```

修改配置文件/etc/my.cnf(在[mysqld]栏中修改一下几行)

```
[mysqld]
port=3306
socket=/tmp/mysql.sock
datadir=/data/mysql
basedir=/usr/local/mysql
```

初始化数据库

```
cd /usr/local/mysql
bin/mysqld --initialize --user=mysql --basedir=/usr/local/mysql --datadir=/data/mysql
bin/mysql_ssl_rsa_setup
```

记下初始化数据库密码

![s.png][1]

[1]: ../images/2396734880.png

将MYSQL服务配置为系统服务

```
cp /usr/local/mysql/support-files/mysql.server /etc/init.d/mysqld
chmod 700 /etc/init.d/mysqld
echo "export PATH=$PATH:/usr/local/mysql/bin" >>/etc/profile
source /etc/profile 也可 ln -s /usr/local/mysql/bin/* /usr/bin/
chkconfig --add mysqld
chkconfig --level 35 mysqld on
service mysqld restart
```

修改初始化密码

```
mysqladmin -uroot -p password 
```

数据库常用配置参数详解

```
[mysqld]   							服务配置
datadir=/data/mysql   					指定数据目录
socket=/var/lib/mysql/mysql.sock 		socket通信文件位置  
user=mysql 							使用mysql用户启动服务
symbolic-links=0  					是否支持快捷方式；
log-bin=mysql-bin  					开启bin-log日志；
server-id = 1  						指定mysql服务的ID；
port             = 3306      			指定MsSQL的端口；
key_buffer       = 384M      		    用于索引块的缓冲区大小（用于myisam引擎）；
table_cache      = 512       			表缓存数量
sort_buffer_size = 2M        			需要排序的线程分配的缓存大小
read_buffer_size = 2M        			需要查询的线程分配的缓存大小
query_cache_size = 32M       			查询结果缓存的大小
myisam_sort_buffer_size = 64M			MyISAM表发生变化时重新排序所需的缓冲；
thread_concurrency      = 8  			最大并发线程数，取值为服务器逻辑CPU数量的2倍
thread_cache            = 8  			缓存可重用的线程数；
skip-locking            				避免MySQL的外部锁定，减少出错几率增强稳定性。 
default-storage-engine=INNODB         设置mysql默认引擎为Innodb；
	
[mysqld_safe]  						mysql服务安全启动配置；
log-error=/var/log/mysqld.log  			mysql错误日志路径；
pid-file=/var/run/mysqld/mysqld.pid 	    mysql PID进程文件；
key_buffer_size = 2048MB				MyISAM表索引缓存的大小；
max_connections = 3000				mysql最大连接数；
innodb_buffer_pool_size	= 2048MB	InnoDB内存缓冲数据和索引大小；
basedir      = /usr/local/mysql55/  	    数据库安装路径；
[mysqldump]			                数据库导出段配置；
max_allowed_packet      =16M 		服务器和客户端发送的最大数据包；
```

MYSQL的性能优化

1. 定位数据库的应用场景，根据数据库的使用目的对数据库进行优化；
2. 选择适合的存储引擎；
3. 将数据缓存到内存中，增加响应速度；
4. 部署集群进行主从复制、读写分离，保障数据安全性减轻服务器负载
5. 优化数据库服务配置参数，对缓存、引擎、最大连接数等参数进行优化；
6. 创建需要查询的数据库上的索引，优化查找响应；





